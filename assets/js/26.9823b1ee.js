(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{215:function(t,e,s){"use strict";s.r(e);var a=s(3),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"clickhouse-sinker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse-sinker"}},[t._v("#")]),t._v(" clickhouse_sinker")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://travis-ci.com/housepower/clickhouse_sinker",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://travis-ci.com/housepower/clickhouse_sinker.svg?branch=master",alt:"Build Status"}}),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://goreportcard.com/report/github.com/housepower/clickhouse_sinker",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://goreportcard.com/badge/github.com/housepower/clickhouse_sinker",alt:"Go Report Card"}}),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("clickhouse_sinker is a sinker program that transfer kafka message into "),e("a",{attrs:{href:"https://clickhouse.yandex/",target:"_blank",rel:"noopener noreferrer"}},[t._v("ClickHouse"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("p",[t._v("Refers to "),e("RouterLink",{attrs:{to:"/dev/design.html"}},[t._v("design")]),t._v(" for how it works.")],1),t._v(" "),e("h2",{attrs:{id:"features"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#features"}},[t._v("#")]),t._v(" Features")]),t._v(" "),e("ul",[e("li",[t._v("Uses native ClickHouse client-server TCP protocol, with higher performance than HTTP.")]),t._v(" "),e("li",[t._v("Easy to use and deploy, you don't need write any hard code, just care about the configuration file")]),t._v(" "),e("li",[t._v("Support multiple parsers: fastjson(recommended), gjson, csv.")]),t._v(" "),e("li",[t._v("Support multiple Kafka security mechanisms: SSL, SASL/PLAIN, SASL/SCRAM, SASL/GSSAPI and combinations of them.")]),t._v(" "),e("li",[t._v("Bulk insert (by config "),e("code",[t._v("bufferSize")]),t._v(" and "),e("code",[t._v("flushInterval")]),t._v(").")]),t._v(" "),e("li",[t._v("Powered by Franz-go, which is the fastest and most cpu and memory efficient Kafka client in Go.")]),t._v(" "),e("li",[t._v("Parse messages concurrently.")]),t._v(" "),e("li",[t._v("Write batches concurrently.")]),t._v(" "),e("li",[t._v("Every batch is routed to a determined clickhouse shard. Exit if loop write fail.")]),t._v(" "),e("li",[t._v("Custom sharding policy (by config "),e("code",[t._v("shardingKey")]),t._v(" and "),e("code",[t._v("shardingPolicy")]),t._v(").")]),t._v(" "),e("li",[t._v("Tolerate replica single-point-failure.")]),t._v(" "),e("li",[t._v("At-least-once delivery guarantee.")]),t._v(" "),e("li",[t._v("Config management with local file or Nacos.")]),t._v(" "),e("li",[t._v("One clickhouse_sinker instance assign tasks to all instances in balance of message lag (by config "),e("code",[t._v("nacos-service-name")]),t._v(").")])]),t._v(" "),e("h2",{attrs:{id:"supported-data-types"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#supported-data-types"}},[t._v("#")]),t._v(" Supported data types")]),t._v(" "),e("ul",[e("li",[t._v("[x] UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64")]),t._v(" "),e("li",[t._v("[x] Float32, Float64")]),t._v(" "),e("li",[t._v("[x] Decimal, Decimal32, Decimal64, Decimal128, Decimal256")]),t._v(" "),e("li",[t._v("[x] String, FixedString, LowCardinality(String)")]),t._v(" "),e("li",[t._v("[x] Date, DateTime, DateTime64. Assuming that all values of a field of kafka message has the same layout, and layouts of each field are unrelated. Automatically detect the layout from "),e("a",{attrs:{href:"https://github.com/housepower/clickhouse_sinker/blob/master/parser/parser.go",target:"_blank",rel:"noopener noreferrer"}},[t._v("these date layouts"),e("OutboundLink")],1),t._v(" till the first successful detection and reuse that layout forever.")]),t._v(" "),e("li",[t._v("[x] UUID")]),t._v(" "),e("li",[t._v("[x] Enum")]),t._v(" "),e("li",[t._v("[x] Array(T), where T is one of above basic types")]),t._v(" "),e("li",[t._v("[x] Nullable(T), where T is one of above basic types")]),t._v(" "),e("li",[t._v("[x] Map")])]),t._v(" "),e("p",[t._v("Note:")]),t._v(" "),e("ul",[e("li",[t._v("A message is ignored if it's invalid json, or CSV value doesn't match with the format. This is counted by "),e("code",[t._v("ParseMsgsErrorTotal")]),t._v(".")]),t._v(" "),e("li",[t._v("If a message field type is imcompatible with the type "),e("code",[t._v("T")]),t._v(" declared in ClickHouse, or field value is invalid to parse, the default value of "),e("code",[t._v("T")]),t._v(" (see the following table) is filled.")]),t._v(" "),e("li",[t._v("If a message field type is compatible with the type "),e("code",[t._v("T")]),t._v(" declared in ClickHouse, but field value is overflow, the nearer border of "),e("code",[t._v("T")]),t._v(" is filled.")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("ClickHouse data type")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("default value")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("compatible Json data type")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("valid range")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Bool")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("false")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Bool")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("false, true")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Int8, Int16, ...")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Bool, Number")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Int8 [-128,127], ...")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Float32, Float64")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("0.0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Number")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Float32 [-MaxFloat32,MaxFloat32], ...")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Decimal, ...")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("0.0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Number")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://clickhouse.tech/docs/en/sql-reference/data-types/decimal/#decimal-value-ranges",target:"_blank",rel:"noopener noreferrer"}},[t._v("decimal-value-ranges"),e("OutboundLink")],1)])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("String, ...")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('""')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Bool, Number, String, Object, Array")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("N/A")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Date, DateTime, ...")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("EPOCH")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("Number, String")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("[EPOCH,MaxUint32_seconds_since_epoch)")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("UUID")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('"00000000-0000-0000-0000-000000000000"')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("String")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("N/A")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Enum")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("N/A")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("String")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("N/A")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Nullable(T)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("NULL")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("(The same as T)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("(The same as T)")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Array(T)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("[]")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("(The same as T)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("(The same as T)")])])])]),t._v(" "),e("h2",{attrs:{id:"benchmark"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#benchmark"}},[t._v("#")]),t._v(" Benchmark")]),t._v(" "),e("h3",{attrs:{id:"clickhouse-sinker-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse-sinker-2"}},[t._v("#")]),t._v(" clickhouse_sinker")]),t._v(" "),e("ul",[e("li",[t._v("ClickHouse cluster: 3 shards, 2 physical hosts in each shard. Each host contains 48 cpu, 256 GB RAM, 12TB HDD RAID5.")]),t._v(" "),e("li",[t._v("ZooKeeper cluster: on three hosts of ClickHouse cluster.")]),t._v(" "),e("li",[t._v("Kafka cluster: 2 nodes on three hosts of ClickHouse cluster. Share the same zookeeper cluster wich ClickHouse.")]),t._v(" "),e("li",[t._v("Kafka topic apache_access_log1: partition 1, replicator factor: 1")]),t._v(" "),e("li",[t._v("Kafka topic apache_access_log2: partition 2, replicator factor: 1")]),t._v(" "),e("li",[t._v("Kafka topic apache_access_log4: partition 4, replicator factor: 1")]),t._v(" "),e("li",[t._v("Generate json messages via kafka_gen_log(https://github.com/housepower/clickhouse_sinker/blob/master/cmd/kafka_gen_log). Messages avg lenght is 754 bytes.")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("config")]),t._v(" "),e("th",[t._v("thoughput(rows/s)")]),t._v(" "),e("th",[t._v("writer total cost")]),t._v(" "),e("th",[t._v("clickhouse cost per node")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("1 kafka partition, 1 sinker")]),t._v(" "),e("td",[t._v("142 K")]),t._v(" "),e("td",[t._v("11.0 cpu, 8 GB")]),t._v(" "),e("td",[t._v("0.3 cpu")])]),t._v(" "),e("tr",[e("td",[t._v("2 kafka partition, 1 sinker")]),t._v(" "),e("td",[t._v("159 K")]),t._v(" "),e("td",[t._v("14.0 cpu, 14 GB")]),t._v(" "),e("td",[t._v("0.7 cpu")])]),t._v(" "),e("tr",[e("td",[t._v("4 kafka partition, 1 sinker")]),t._v(" "),e("td",[t._v("25~127 K")]),t._v(" "),e("td",[t._v("2~22 cpu, 16 GB")]),t._v(" "),e("td",[t._v("1 cpu")])]),t._v(" "),e("tr",[e("td",[t._v("2 kafka partition, 2 sinker")]),t._v(" "),e("td",[t._v("275 K")]),t._v(" "),e("td",[t._v("22 cpu, 8 GB")]),t._v(" "),e("td",[t._v("1.3 cpu")])]),t._v(" "),e("tr",[e("td",[t._v("4 kafka partition, 2 sinker")]),t._v(" "),e("td",[t._v("301 K")]),t._v(" "),e("td",[t._v("25 cpu, 18 GB")]),t._v(" "),e("td",[t._v("1.5 cpu")])])])]),t._v(" "),e("h3",{attrs:{id:"flink-pipeline"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flink-pipeline"}},[t._v("#")]),t._v(" Flink pipeline")]),t._v(" "),e("p",[t._v("Here's the Flink pipeline which moves date from kafka to ClickHouse. The cpu hotspot of the Flink pipeline is JSON decode, and Row.setField.")]),t._v(" "),e("p",[t._v("Kafka Source -> JSON decode -> DateTime formart conversion -> Interger type conversion -> JDBCSinkJob")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("config")]),t._v(" "),e("th",[t._v("thoughput(rows/s)")]),t._v(" "),e("th",[t._v("writer total cost")]),t._v(" "),e("th",[t._v("clickhouse cost per node")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("1 kafka partition, pipeline Parallelism: 20")]),t._v(" "),e("td",[t._v("44.7 K")]),t._v(" "),e("td",[t._v("13.8 cpu, 20 GB")]),t._v(" "),e("td",[t._v("1.1 cpu")])])])]),t._v(" "),e("h3",{attrs:{id:"conclusion"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[t._v("#")]),t._v(" Conclusion")]),t._v(" "),e("ul",[e("li",[t._v("clickhouse_sinker is 3x fast as the Flink pipeline, and cost much less connection and cpu overhead on clickhouse-server.")]),t._v(" "),e("li",[t._v("clickhouse_sinker retry other replicas on writing failures.")]),t._v(" "),e("li",[t._v("clickhouse_sinker get table schema from ClickHouse. The pipeline need manual config of all fields.")]),t._v(" "),e("li",[t._v("clickhouse_sinker detect DateTime format. The pipeline need dedicated steps to do format and type conversion.")])]),t._v(" "),e("h2",{attrs:{id:"configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[t._v("#")]),t._v(" Configuration")]),t._v(" "),e("p",[t._v("Refers to how "),e("a",{attrs:{href:"https://github.com/housepower/clickhouse_sinker/blob/master/go.test.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("integration test"),e("OutboundLink")],1),t._v(" use the example config. Also refers to "),e("a",{attrs:{href:"https://github.com/housepower/clickhouse_sinker/blob/master/config/config.go",target:"_blank",rel:"noopener noreferrer"}},[t._v("code"),e("OutboundLink")],1),t._v(" for all config items.")]),t._v(" "),e("h3",{attrs:{id:"kafka-encryption"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kafka-encryption"}},[t._v("#")]),t._v(" Kafka Encryption")]),t._v(" "),e("p",[t._v("clickhouse_sinker supports following encryption mechanisms:")]),t._v(" "),e("ul",[e("li",[t._v("No encryption")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9092"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Required if you use sarama. It\'s the the Kafka server version."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ul",[e("li",[t._v("Encryption using SSL")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9093"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"tls"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"enable"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@trustStoreLocation"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssl.truststore.location which kafka-console-consumer.sh uses"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"trustStoreLocation"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/security/kafka.client.truststore.jks"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@trustStorePassword"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssl.truststore.password which kafka-console-consumer.sh uses"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"trustStorePassword"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@endpIdentAlgo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssl.endpoint.identification.algorithm which kafka-console-consumer.sh uses"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"endpIdentAlgo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("Or if you have extracted certificates from JKS, use the following config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9093"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"tls"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"enable"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@caCertFiles"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Required. It\'s the CA certificate with which Kafka brokers certs be signed. This cert is added to kafka.client.truststore.jks which kafka-console-consumer.sh uses"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"caCertFiles"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/security/ca-cert"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@endpIdentAlgo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssl.endpoint.identification.algorithm which kafka-console-consumer.sh uses"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"endpIdentAlgo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("FYI. "),e("code",[t._v("kafka-console-consumer.sh")]),t._v(" works as the following setup:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" config/client_SSL_NOAUTH.properties\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("security.protocol")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SSL\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ssl.truststore.location")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/security/kafka.client.truststore.jks\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ssl.truststore.password")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ssl.endpoint.identification.algorithm")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\n$ bin/kafka-console-consumer.sh --bootstrap-server "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--group")]),t._v(" test-consumer-group --from-beginning "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--consumer.config")]),t._v(" config/client_SSL_NOAUTH.properties\n")])])]),e("p",[t._v("Please follow "),e("a",{attrs:{href:"https://kafka.apache.org/documentation/#security_ssl",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Kafka SSL setup")]),e("OutboundLink")],1),t._v(". Use "),e("code",[t._v("-keyalg RSA")]),t._v(" when you create the broker keystore, otherwise there will be no cipher suites in common between the keystore and those Golang supports. See "),e("a",{attrs:{href:"https://github.com/Shopify/sarama/issues/643#issuecomment-216839760",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),e("OutboundLink")],1),t._v(" for reference.")]),t._v(" "),e("h3",{attrs:{id:"kafka-authentication"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kafka-authentication"}},[t._v("#")]),t._v(" Kafka Authentication")]),t._v(" "),e("p",[t._v("clickhouse_sinker support the following authentication mechanisms:")]),t._v(" "),e("ul",[e("li",[t._v("No authentication")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9092"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Required if you use sarama. It\'s the the Kafka server version."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ul",[e("li",[t._v("SASL/PLAIN")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9094"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sasl"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"enable"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mechanism"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PLAIN"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"username"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice-secret"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("FYI. Java clients work with the following setup:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" config/client_PLAINTEXT_PLAIN.properties\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("security.protocol")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SASL_PLAINTEXT\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.kerberos.service.name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kafka\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.mechanism")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("PLAIN\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.jaas.config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("org.apache.kafka.common.security.plain.PlainLoginModule required "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("username")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("password")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice-secret"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n$ bin/kafka-console-producer.sh --broker-list "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--producer.config")]),t._v(" config/client_PLAINTEXT_PLAIN.properties\n\n$ bin/kafka-console-consumer.sh --bootstrap-server "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--group")]),t._v(" test-consumer-group --from-beginning "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--consumer.config")]),t._v(" config/client_PLAINTEXT_PLAIN.properties\n")])])]),e("ul",[e("li",[t._v("SASL/SCRAM")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9094"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sasl"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"enable"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@mechanism"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SCRAM-SHA-256 or SCRAM-SHA-512"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mechanism"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SCRAM-SHA-256"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"username"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice-secret"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("FYI. Java clients work with the following setup:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" config/client_PLAINTEXT_SCRAM.properties\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("security.protocol")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SASL_PLAINTEXT\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.kerberos.service.name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kafka\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.mechanism")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SCRAM-SHA-256\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.jaas.config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("org.apache.kafka.common.security.scram.ScramLoginModule required "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("username")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("password")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alice-secret"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n$ bin/kafka-console-producer.sh --broker-list "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--producer.config")]),t._v(" config/client_PLAINTEXT_SCRAM.properties\n\n$ bin/kafka-console-consumer.sh --bootstrap-server "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--group")]),t._v(" test-consumer-group --from-beginning "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--consumer.config")]),t._v(" config/client_PLAINTEXT_SCRAM.properties\n")])])]),e("ul",[e("li",[t._v("SASL/GSSAPI(Kerberos)")])]),t._v(" "),e("p",[t._v("An example kafka config:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"brokers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.64:9094"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2.5.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sasl"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"enable"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mechanism"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GSSAPI"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"gssapi"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@authtype"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1 - Username and password, 2 - Keytab"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"authtype"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"keytabpath"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/security/mmmtest.keytab"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kerberosconfigpath"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/krb5.conf"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"servicename"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kafka"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@username"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"`principal` consists of `username` `@` `realm`"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"username"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mmm"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"realm"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ALANWANG.COM"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("FYI. Java clients work with the following setup:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" config/client_PLAINTEXT_GSSAPI.properties\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("security.protocol")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SASL_PLAINTEXT\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.kerberos.service.name")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kafka\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.mechanism")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("GSSAPI\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sasl.jaas.config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("com.sun.security.auth.module.Krb5LoginModule required "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("useKeyTab")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("storeKey")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("debug")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("keyTab")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/security/mmmtest.keytab"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("principal")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mmm@ALANWANG.COM"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n$ bin/kafka-console-producer.sh --broker-list "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--producer.config")]),t._v(" config/client_PLAINTEXT_GSSAPI.properties\n\n$ bin/kafka-console-consumer.sh --bootstrap-server "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.64:9094 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--topic")]),t._v(" sunshine "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--group")]),t._v(" test-consumer-group --from-beginning "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--consumer.config")]),t._v(" config/client_PLAINTEXT_GSSAPI.properties\n")])])]),e("p",[t._v("Kerberos setup is complex. Please ensure "),e("a",{attrs:{href:"https://docs.cloudera.com/runtime/7.2.1/kafka-managing/topics/kafka-manage-cli-consumer.html",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("kafka-console-consumer.sh")]),e("OutboundLink")],1),t._v(" Kerberos keytab authentication work STRICTLY FOLLOW "),e("a",{attrs:{href:"https://stackoverflow.com/questions/48744660/kafka-console-consumer-with-kerberos-authentication/49140414#49140414",target:"_blank",rel:"noopener noreferrer"}},[t._v("this article"),e("OutboundLink")],1),t._v(", then test "),e("code",[t._v("clickhouse_sinker")]),t._v(" Kerberos authentication on the SAME machine which "),e("code",[t._v("kafka-console-consumer.sh")]),t._v(" runs. I tested sarama Kerberos authentication against Kafka "),e("a",{attrs:{href:"https://archive.apache.org/dist/kafka/2.2.1/kafka_2.11-2.2.1.tgz",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1"),e("OutboundLink")],1),t._v(". Not sure other Kafka versions work.")]),t._v(" "),e("h3",{attrs:{id:"sharding-policy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sharding-policy"}},[t._v("#")]),t._v(" Sharding Policy")]),t._v(" "),e("p",[t._v("Every message is routed to a determined ClickHouse shard.")]),t._v(" "),e("p",[t._v("By default, the shard number is caculated by "),e("code",[t._v("(kafka_offset/roundup(buffer_size))%clickhouse_shards")]),t._v(", where "),e("code",[t._v("roundup()")]),t._v(" round upward an unsigned integer to the the nearest 2^n.")]),t._v(" "),e("p",[t._v("This above expression can be customized with "),e("code",[t._v("shardingKey")]),t._v(" and "),e("code",[t._v("shardingPolicy")]),t._v(". "),e("code",[t._v("shardingKey")]),t._v(" value is a column name. "),e("code",[t._v("shardingPolicy")]),t._v(" value could be:")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("stripe,<size>")]),t._v(". This requires "),e("code",[t._v("shardingKey")]),t._v(" be a numeric-like (bool, int, float, date etc.) column. The expression is "),e("code",[t._v("(uint64(shardingKey)/stripe_size)%clickhouse_shards")]),t._v(".")]),t._v(" "),e("li",[e("code",[t._v("hash")]),t._v(". This requires "),e("code",[t._v("shardingKey")]),t._v(" be a string-like column. The hash function used internally is "),e("a",{attrs:{href:"https://github.com/cespare/xxhash",target:"_blank",rel:"noopener noreferrer"}},[t._v("xxHash64"),e("OutboundLink")],1),t._v(". The expression is "),e("code",[t._v("xxhash64(string(shardingKey))%clickhouse_shards")]),t._v(".")])]),t._v(" "),e("h2",{attrs:{id:"configuration-management"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configuration-management"}},[t._v("#")]),t._v(" Configuration Management")]),t._v(" "),e("p",[t._v("The precedence of config items:")]),t._v(" "),e("ul",[e("li",[t._v("CLI parameters > env variables")]),t._v(" "),e("li",[t._v("Nacos > Local Config File")])]),t._v(" "),e("h3",{attrs:{id:"nacos"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nacos"}},[t._v("#")]),t._v(" Nacos")]),t._v(" "),e("p",[t._v("Sinker is able to register with Nacos, get and apply config changes dynamically without restart the whole process.\nControled by:")]),t._v(" "),e("ul",[e("li",[t._v("CLI parameters: "),e("code",[t._v("nacos-addr, nacos-username, nacos-password, nacos-namespace-id, nacos-group, nacos-dataid")])]),t._v(" "),e("li",[t._v("env variables: "),e("code",[t._v("NACOS_ADDR, NACOS_USERNAME, NACOS_PASSWORD, NACOS_NAMESPACE_ID, NACOS_GROUP, NACOS_DATAID")])])]),t._v(" "),e("h3",{attrs:{id:"local-config-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#local-config-file"}},[t._v("#")]),t._v(" Local Config File")]),t._v(" "),e("p",[t._v("Currently sinker is able to parse local config file at startup, but unable to detect file changes.\nControled by:")]),t._v(" "),e("ul",[e("li",[t._v("CLI parameters: "),e("code",[t._v("local-cfg-file")])]),t._v(" "),e("li",[t._v("env variables: "),e("code",[t._v("LOCAL_CFG_FILE")])])]),t._v(" "),e("h2",{attrs:{id:"prometheus-metrics"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prometheus-metrics"}},[t._v("#")]),t._v(" Prometheus Metrics")]),t._v(" "),e("p",[t._v("All metrics are defined in "),e("code",[t._v("statistics.go")]),t._v(". You can create Grafana dashboard for clickhouse_sinker by importing the template "),e("code",[t._v("clickhouse_sinker-dashboard.json")]),t._v(".")]),t._v(" "),e("ul",[e("li",[t._v("Pull with prometheus")])]),t._v(" "),e("p",[t._v("Metrics are exposed at "),e("code",[t._v("http://ip:port/metrics")]),t._v(". IP is the outbound IP of this machine. Port is from CLI "),e("code",[t._v("--http-port")]),t._v(" or env "),e("code",[t._v("HTTP_PORT")]),t._v(".")]),t._v(" "),e("p",[t._v("Sinker registers with Nacos if CLI "),e("code",[t._v("--consul-cfg-enable")]),t._v(" or env "),e("code",[t._v("CONSUL_REGISTER_ENABLE")]),t._v(" is present. However Prometheus is "),e("a",{attrs:{href:"https://github.com/alibaba/nacos/issues/1032",target:"_blank",rel:"noopener noreferrer"}},[t._v("unable"),e("OutboundLink")],1),t._v(" to obtain dynamic service list from nacos server.")]),t._v(" "),e("ul",[e("li",[t._v("Push to prometheus")])]),t._v(" "),e("p",[t._v("If CLI "),e("code",[t._v("--metric-push-gateway-addrs")]),t._v(" or env "),e("code",[t._v("METRIC_PUSH_GATEWAY_ADDRS")]),t._v(" (a list of comma-separated urls) is present, metrics are pushed to one of given URLs regualarly.")]),t._v(" "),e("h2",{attrs:{id:"extending"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#extending"}},[t._v("#")]),t._v(" Extending")]),t._v(" "),e("p",[t._v("There are several abstract interfaces which you can implement to support more message format, message queue and config management mechanism.")]),t._v(" "),e("div",{staticClass:"language-go extra-class"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Parser "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Parse")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bs "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" model"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metric\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// RemoteConfManager can be implemented by many backends: Nacos, Consul, etcd, ZooKeeper...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" RemoteConfManager "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Init")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("properties "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// PublishConfig publishs the config. The manager shall not reference the passed Config object after call.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("PublishConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"why-not-kafka-engine-built-in-clickhouse"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#why-not-kafka-engine-built-in-clickhouse"}},[t._v("#")]),t._v(" Why not "),e("a",{attrs:{href:"https://clickhouse.tech/docs/en/engines/table-engines/integrations/kafka/",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Kafka Engine")]),e("OutboundLink")],1),t._v(" built in ClickHouse?")]),t._v(" "),e("ul",[e("li",[t._v("My experience indicates "),e("code",[t._v("Kafka Engine")]),t._v(" is complicated, buggy and hard to debug.")]),t._v(" "),e("li",[e("code",[t._v("Kafka Engine")]),t._v(" runs inside the db process, lowers the database stability. On the other side, "),e("a",{attrs:{href:"https://www.vertica.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Vertica"),e("OutboundLink")],1),t._v("'s official kafka importer is separated with the database server.")]),t._v(" "),e("li",[e("code",[t._v("Kafka Engine")]),t._v(" doesn't support custom sharding policy.")]),t._v(" "),e("li",[t._v("Neither "),e("code",[t._v("Kafka Engine")]),t._v(" nor clickhouse_sinker support exactly-once.")])]),t._v(" "),e("h2",{attrs:{id:"kafka-compatibility"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kafka-compatibility"}},[t._v("#")]),t._v(" Kafka Compatibility")]),t._v(" "),e("p",[t._v("Kafka release history is at "),e("a",{attrs:{href:"https://kafka.apache.org/downloads",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(". Kafka broker "),e("a",{attrs:{href:"https://kafka.apache.org/protocol#api_versions",target:"_blank",rel:"noopener noreferrer"}},[t._v("exposes versions of various APIs it supports since 0.10.0.0"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("h3",{attrs:{id:"franz-go-kafka-client"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#franz-go-kafka-client"}},[t._v("#")]),t._v(" Franz-go Kafka client")]),t._v(" "),e("ul",[e("li",[t._v("Franz negotiates it's protocol version.")]),t._v(" "),e("li",[t._v("Franz supports Kerberos authentication.")]),t._v(" "),e("li",[t._v("Franz supports generation cleanup callback.")]),t._v(" "),e("li",[t._v("Franz wins Sarama and Kafka-go at benchmark competition.")]),t._v(" "),e("li",[t._v("Franz project is young but very active.")])])])}),[],!1,null,null,null);e.default=r.exports}}]);