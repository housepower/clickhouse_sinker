<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Architecture | clickhouse_sinker</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="clickhouse_sinker a tool to sink the data into ClickHouse">
    
    <link rel="preload" href="/clickhouse_sinker/assets/css/0.styles.8da16afe.css" as="style"><link rel="preload" href="/clickhouse_sinker/assets/js/app.7cdffb3e.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/2.15f0877f.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/1.aa70cc6d.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/25.acb0c4bc.js" as="script"><link rel="prefetch" href="/clickhouse_sinker/assets/js/10.de70aa22.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/11.b545c0f4.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/12.79499452.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/13.9a6e2e92.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/14.ed3e6c9c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/15.bb480568.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/16.87182236.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/17.459cf0b5.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/18.56a27ee8.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/19.e77da72f.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/20.2570c495.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/21.4e9fc147.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/22.996f91ea.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/23.305fa022.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/24.fa471a3c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/26.9823b1ee.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/27.2ff499e0.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/28.36ca858c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/29.0fdbe177.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/3.185e9064.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/4.decd81bd.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/5.1a4d9ec7.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/6.c789d3ea.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/7.d74bfc49.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/vendors~docsearch.d74c0d36.js">
    <link rel="stylesheet" href="/clickhouse_sinker/assets/css/0.styles.8da16afe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clickhouse_sinker/" class="home-link router-link-active"><!----> <span class="site-name">clickhouse_sinker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Development</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clickhouse_sinker/dev/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/clickhouse_sinker/dev/design.html" aria-current="page" class="active sidebar-link">Design</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/design.html#sharding" class="sidebar-link">Sharding</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/design.html#workflow" class="sidebar-link">Workflow</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/design.html#task-scheduling" class="sidebar-link">Task scheduling</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h1> <h2 id="sharding"><a href="#sharding" class="header-anchor">#</a> Sharding</h2> <p>clickhouse_sinker guarantee:</p> <ul><li>at-least-once</li> <li>Duplicated messages (per topic-partition-offset) are routed to the same ClickHouse shard.</li></ul> <p>So if you setup ClickHouse properly(ReplacingMergeTree ORDER BY (__kafak_topic, __kafka_partition, __kafka_offset)), you could get exactly-once semantic.</p> <p>It's hard for clickhouse_sinker to guarantee exactly-once semantic without ReplacingMergeTree. Kafka consumer group load-balance cause duplicated messages if one consumer crash suddenly.</p> <h2 id="workflow"><a href="#workflow" class="header-anchor">#</a> Workflow</h2> <p>Internally, clickhouse_sinker groups tasks that with identical &quot;consumerGroup&quot; property set together for the purpose of reducing the number of Kafka client, so that Kafka server is able to handle more requests concurrently. And consequently, it's decided to commit Kafka offset only after messages in a whole fetch got written to clickhouse completely.</p> <p>The flow is like this:</p> <ul><li>Group tasks with identical &quot;consumerGroup&quot; property together, fetch messages for the group of tasks with a single goroutine.</li> <li>Route fetched messages to the individual tasks for further parsing. By default, the mapping between messages and tasks is controlled by &quot;topic&quot; and &quot;tableName&quot; property. But for messages with Kafka header &quot;__table_name&quot; specified, the mapping between &quot;__table_name&quot; and &quot;tableName&quot; will override the default behavior.</li> <li>Parse messages and calculate the dest shard:
-- For tasks with &quot;shardingkey&quot; property specified, if the sharding key is numerical(integer, float, time, etc.), the dest shard is determined by <code>(shardingKey/shardingStripe)%clickhouse_shards</code>, if not, it is determined by <code>xxHash64(shardingKey)%clickhouse_shards</code>.
-- Otherwise, the dest shard for each message is determined by <code>(kafka_offset/roundup(buffer_size))%clickhouse_shards</code>.</li> <li>Generate batches for all shard slots that are in the same Group, when total cached message count in the Group reached <code>sum(batchSize)*80%</code> boundary or flush timer fire.</li> <li>Write batches to ClickHouse in a global goroutine pool(pool size is a fixed number based on the number of tasks and Clickhouse shards).</li> <li>Commit offset back to Kafka</li></ul> <h2 id="task-scheduling"><a href="#task-scheduling" class="header-anchor">#</a> Task scheduling</h2> <p>The clickhouse-server configuration item <code>max_concurrent_queries</code>(default 100) is the maximum number of simultaneously processed queries related to MergeTree table. If the number of concurrent INSERT is close to <code>max_concurrent_queries</code>, the user queries(<code>SELECT</code>) could fail due to the limit.</p> <p>If the clickhouse-server is big, ingesting data to &gt;=100 MergeTree tables via clickhouse_sinker bring pressure to the Clickhouse cluster. On the other side, large number of clickhouse_sinker instances requires lots of CPU/MEM resources.</p> <p>The solution is, clickhouse_sinker instances coordinate with each other to assign tasks among themselves.</p> <p>The task scheduling procedure:</p> <ul><li>Some platform(Kubernetes, Yarn, etc.) start several clickhouse_sinker instances and may start/stop instances dynamically. Every clickhouse_sinker instance registers with Nacos as a single service(CLI option <code>--nacos-service-name</code>).</li> <li>Someone publish(add/delete/modify) a list of tasks(with empty assignment) to Nacos.</li> <li>The first clickhouse_sinker(per instance's ip+port) instance(named scheduler) is responsible to generate and publish task assignments regularly. The task list and assignment consist of the whole config. The task list change, service change, and task lag change will trigger another assignment. The scheduler ensures Each clickhouse_innker instance's total lag be balanced.</li> <li>Each clickhouse_sinker reloads the config regularly. This may start/stop tasks. clickhouse_sinker stops tasks gracefully so that there's no message lost/duplication during task transferring.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/clickhouse_sinker/dev/introduction.html" class="prev">
        Introduction
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/clickhouse_sinker/assets/js/app.7cdffb3e.js" defer></script><script src="/clickhouse_sinker/assets/js/2.15f0877f.js" defer></script><script src="/clickhouse_sinker/assets/js/1.aa70cc6d.js" defer></script><script src="/clickhouse_sinker/assets/js/25.acb0c4bc.js" defer></script>
  </body>
</html>
