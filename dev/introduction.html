<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>clickhouse_sinker | clickhouse_sinker</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="clickhouse_sinker a tool to sink the data into ClickHouse">
    
    <link rel="preload" href="/clickhouse_sinker/assets/css/0.styles.8da16afe.css" as="style"><link rel="preload" href="/clickhouse_sinker/assets/js/app.7cdffb3e.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/2.15f0877f.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/1.aa70cc6d.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/26.9823b1ee.js" as="script"><link rel="prefetch" href="/clickhouse_sinker/assets/js/10.de70aa22.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/11.b545c0f4.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/12.79499452.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/13.9a6e2e92.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/14.ed3e6c9c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/15.bb480568.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/16.87182236.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/17.459cf0b5.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/18.56a27ee8.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/19.e77da72f.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/20.2570c495.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/21.4e9fc147.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/22.996f91ea.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/23.305fa022.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/24.fa471a3c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/25.acb0c4bc.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/27.2ff499e0.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/28.36ca858c.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/29.0fdbe177.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/3.185e9064.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/4.decd81bd.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/5.1a4d9ec7.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/6.c789d3ea.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/7.d74bfc49.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/vendors~docsearch.d74c0d36.js">
    <link rel="stylesheet" href="/clickhouse_sinker/assets/css/0.styles.8da16afe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clickhouse_sinker/" class="home-link router-link-active"><!----> <span class="site-name">clickhouse_sinker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Development</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="active sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#features" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#supported-data-types" class="sidebar-link">Supported data types</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#benchmark" class="sidebar-link">Benchmark</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#configuration-management" class="sidebar-link">Configuration Management</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#prometheus-metrics" class="sidebar-link">Prometheus Metrics</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#extending" class="sidebar-link">Extending</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#why-not-kafka-engine-built-in-clickhouse" class="sidebar-link">Why not Kafka Engine built in ClickHouse?</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#kafka-compatibility" class="sidebar-link">Kafka Compatibility</a></li></ul></li><li><a href="/clickhouse_sinker/dev/design.html" class="sidebar-link">Design</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="clickhouse-sinker"><a href="#clickhouse-sinker" class="header-anchor">#</a> clickhouse_sinker</h1> <p><a href="https://travis-ci.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer"><img src="https://travis-ci.com/housepower/clickhouse_sinker.svg?branch=master" alt="Build Status"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://goreportcard.com/report/github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer"><img src="https://goreportcard.com/badge/github.com/housepower/clickhouse_sinker" alt="Go Report Card"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>clickhouse_sinker is a sinker program that transfer kafka message into <a href="https://clickhouse.yandex/" target="_blank" rel="noopener noreferrer">ClickHouse<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Refers to <a href="/clickhouse_sinker/dev/design.html">design</a> for how it works.</p> <h2 id="features"><a href="#features" class="header-anchor">#</a> Features</h2> <ul><li>Uses native ClickHouse client-server TCP protocol, with higher performance than HTTP.</li> <li>Easy to use and deploy, you don't need write any hard code, just care about the configuration file</li> <li>Support multiple parsers: fastjson(recommended), gjson, csv.</li> <li>Support multiple Kafka security mechanisms: SSL, SASL/PLAIN, SASL/SCRAM, SASL/GSSAPI and combinations of them.</li> <li>Bulk insert (by config <code>bufferSize</code> and <code>flushInterval</code>).</li> <li>Powered by Franz-go, which is the fastest and most cpu and memory efficient Kafka client in Go.</li> <li>Parse messages concurrently.</li> <li>Write batches concurrently.</li> <li>Every batch is routed to a determined clickhouse shard. Exit if loop write fail.</li> <li>Custom sharding policy (by config <code>shardingKey</code> and <code>shardingPolicy</code>).</li> <li>Tolerate replica single-point-failure.</li> <li>At-least-once delivery guarantee.</li> <li>Config management with local file or Nacos.</li> <li>One clickhouse_sinker instance assign tasks to all instances in balance of message lag (by config <code>nacos-service-name</code>).</li></ul> <h2 id="supported-data-types"><a href="#supported-data-types" class="header-anchor">#</a> Supported data types</h2> <ul><li>[x] UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64</li> <li>[x] Float32, Float64</li> <li>[x] Decimal, Decimal32, Decimal64, Decimal128, Decimal256</li> <li>[x] String, FixedString, LowCardinality(String)</li> <li>[x] Date, DateTime, DateTime64. Assuming that all values of a field of kafka message has the same layout, and layouts of each field are unrelated. Automatically detect the layout from <a href="https://github.com/housepower/clickhouse_sinker/blob/master/parser/parser.go" target="_blank" rel="noopener noreferrer">these date layouts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> till the first successful detection and reuse that layout forever.</li> <li>[x] UUID</li> <li>[x] Enum</li> <li>[x] Array(T), where T is one of above basic types</li> <li>[x] Nullable(T), where T is one of above basic types</li> <li>[x] Map</li></ul> <p>Note:</p> <ul><li>A message is ignored if it's invalid json, or CSV value doesn't match with the format. This is counted by <code>ParseMsgsErrorTotal</code>.</li> <li>If a message field type is imcompatible with the type <code>T</code> declared in ClickHouse, or field value is invalid to parse, the default value of <code>T</code> (see the following table) is filled.</li> <li>If a message field type is compatible with the type <code>T</code> declared in ClickHouse, but field value is overflow, the nearer border of <code>T</code> is filled.</li></ul> <table><thead><tr><th style="text-align:center;">ClickHouse data type</th> <th style="text-align:center;">default value</th> <th style="text-align:center;">compatible Json data type</th> <th style="text-align:center;">valid range</th></tr></thead> <tbody><tr><td style="text-align:center;">Bool</td> <td style="text-align:center;">false</td> <td style="text-align:center;">Bool</td> <td style="text-align:center;">false, true</td></tr> <tr><td style="text-align:center;">Int8, Int16, ...</td> <td style="text-align:center;">0</td> <td style="text-align:center;">Bool, Number</td> <td style="text-align:center;">Int8 [-128,127], ...</td></tr> <tr><td style="text-align:center;">Float32, Float64</td> <td style="text-align:center;">0.0</td> <td style="text-align:center;">Number</td> <td style="text-align:center;">Float32 [-MaxFloat32,MaxFloat32], ...</td></tr> <tr><td style="text-align:center;">Decimal, ...</td> <td style="text-align:center;">0.0</td> <td style="text-align:center;">Number</td> <td style="text-align:center;"><a href="https://clickhouse.tech/docs/en/sql-reference/data-types/decimal/#decimal-value-ranges" target="_blank" rel="noopener noreferrer">decimal-value-ranges<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:center;">String, ...</td> <td style="text-align:center;">&quot;&quot;</td> <td style="text-align:center;">Bool, Number, String, Object, Array</td> <td style="text-align:center;">N/A</td></tr> <tr><td style="text-align:center;">Date, DateTime, ...</td> <td style="text-align:center;">EPOCH</td> <td style="text-align:center;">Number, String</td> <td style="text-align:center;">[EPOCH,MaxUint32_seconds_since_epoch)</td></tr> <tr><td style="text-align:center;">UUID</td> <td style="text-align:center;">&quot;00000000-0000-0000-0000-000000000000&quot;</td> <td style="text-align:center;">String</td> <td style="text-align:center;">N/A</td></tr> <tr><td style="text-align:center;">Enum</td> <td style="text-align:center;">N/A</td> <td style="text-align:center;">String</td> <td style="text-align:center;">N/A</td></tr> <tr><td style="text-align:center;">Nullable(T)</td> <td style="text-align:center;">NULL</td> <td style="text-align:center;">(The same as T)</td> <td style="text-align:center;">(The same as T)</td></tr> <tr><td style="text-align:center;">Array(T)</td> <td style="text-align:center;">[]</td> <td style="text-align:center;">(The same as T)</td> <td style="text-align:center;">(The same as T)</td></tr></tbody></table> <h2 id="benchmark"><a href="#benchmark" class="header-anchor">#</a> Benchmark</h2> <h3 id="clickhouse-sinker-2"><a href="#clickhouse-sinker-2" class="header-anchor">#</a> clickhouse_sinker</h3> <ul><li>ClickHouse cluster: 3 shards, 2 physical hosts in each shard. Each host contains 48 cpu, 256 GB RAM, 12TB HDD RAID5.</li> <li>ZooKeeper cluster: on three hosts of ClickHouse cluster.</li> <li>Kafka cluster: 2 nodes on three hosts of ClickHouse cluster. Share the same zookeeper cluster wich ClickHouse.</li> <li>Kafka topic apache_access_log1: partition 1, replicator factor: 1</li> <li>Kafka topic apache_access_log2: partition 2, replicator factor: 1</li> <li>Kafka topic apache_access_log4: partition 4, replicator factor: 1</li> <li>Generate json messages via kafka_gen_log(https://github.com/housepower/clickhouse_sinker/blob/master/cmd/kafka_gen_log). Messages avg lenght is 754 bytes.</li></ul> <table><thead><tr><th>config</th> <th>thoughput(rows/s)</th> <th>writer total cost</th> <th>clickhouse cost per node</th></tr></thead> <tbody><tr><td>1 kafka partition, 1 sinker</td> <td>142 K</td> <td>11.0 cpu, 8 GB</td> <td>0.3 cpu</td></tr> <tr><td>2 kafka partition, 1 sinker</td> <td>159 K</td> <td>14.0 cpu, 14 GB</td> <td>0.7 cpu</td></tr> <tr><td>4 kafka partition, 1 sinker</td> <td>25~127 K</td> <td>2~22 cpu, 16 GB</td> <td>1 cpu</td></tr> <tr><td>2 kafka partition, 2 sinker</td> <td>275 K</td> <td>22 cpu, 8 GB</td> <td>1.3 cpu</td></tr> <tr><td>4 kafka partition, 2 sinker</td> <td>301 K</td> <td>25 cpu, 18 GB</td> <td>1.5 cpu</td></tr></tbody></table> <h3 id="flink-pipeline"><a href="#flink-pipeline" class="header-anchor">#</a> Flink pipeline</h3> <p>Here's the Flink pipeline which moves date from kafka to ClickHouse. The cpu hotspot of the Flink pipeline is JSON decode, and Row.setField.</p> <p>Kafka Source -&gt; JSON decode -&gt; DateTime formart conversion -&gt; Interger type conversion -&gt; JDBCSinkJob</p> <table><thead><tr><th>config</th> <th>thoughput(rows/s)</th> <th>writer total cost</th> <th>clickhouse cost per node</th></tr></thead> <tbody><tr><td>1 kafka partition, pipeline Parallelism: 20</td> <td>44.7 K</td> <td>13.8 cpu, 20 GB</td> <td>1.1 cpu</td></tr></tbody></table> <h3 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h3> <ul><li>clickhouse_sinker is 3x fast as the Flink pipeline, and cost much less connection and cpu overhead on clickhouse-server.</li> <li>clickhouse_sinker retry other replicas on writing failures.</li> <li>clickhouse_sinker get table schema from ClickHouse. The pipeline need manual config of all fields.</li> <li>clickhouse_sinker detect DateTime format. The pipeline need dedicated steps to do format and type conversion.</li></ul> <h2 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h2> <p>Refers to how <a href="https://github.com/housepower/clickhouse_sinker/blob/master/go.test.sh" target="_blank" rel="noopener noreferrer">integration test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> use the example config. Also refers to <a href="https://github.com/housepower/clickhouse_sinker/blob/master/config/config.go" target="_blank" rel="noopener noreferrer">code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for all config items.</p> <h3 id="kafka-encryption"><a href="#kafka-encryption" class="header-anchor">#</a> Kafka Encryption</h3> <p>clickhouse_sinker supports following encryption mechanisms:</p> <ul><li>No encryption</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Required if you use sarama. It's the the Kafka server version.&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>Encryption using SSL</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9093&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tls&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;enable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@trustStoreLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ssl.truststore.location which kafka-console-consumer.sh uses&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;trustStoreLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/security/kafka.client.truststore.jks&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@trustStorePassword&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ssl.truststore.password which kafka-console-consumer.sh uses&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;trustStorePassword&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@endpIdentAlgo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ssl.endpoint.identification.algorithm which kafka-console-consumer.sh uses&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;endpIdentAlgo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>Or if you have extracted certificates from JKS, use the following config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9093&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tls&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;enable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@caCertFiles&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Required. It's the CA certificate with which Kafka brokers certs be signed. This cert is added to kafka.client.truststore.jks which kafka-console-consumer.sh uses&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;caCertFiles&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/security/ca-cert&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@endpIdentAlgo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ssl.endpoint.identification.algorithm which kafka-console-consumer.sh uses&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;endpIdentAlgo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>FYI. <code>kafka-console-consumer.sh</code> works as the following setup:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> config/client_SSL_NOAUTH.properties
<span class="token assign-left variable">security.protocol</span><span class="token operator">=</span>SSL
<span class="token assign-left variable">ssl.truststore.location</span><span class="token operator">=</span>/etc/security/kafka.client.truststore.jks
<span class="token assign-left variable">ssl.truststore.password</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">ssl.endpoint.identification.algorithm</span><span class="token operator">=</span>

$ bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--group</span> test-consumer-group --from-beginning <span class="token parameter variable">--consumer.config</span> config/client_SSL_NOAUTH.properties
</code></pre></div><p>Please follow <a href="https://kafka.apache.org/documentation/#security_ssl" target="_blank" rel="noopener noreferrer"><code>Kafka SSL setup</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Use <code>-keyalg RSA</code> when you create the broker keystore, otherwise there will be no cipher suites in common between the keystore and those Golang supports. See <a href="https://github.com/Shopify/sarama/issues/643#issuecomment-216839760" target="_blank" rel="noopener noreferrer">this<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for reference.</p> <h3 id="kafka-authentication"><a href="#kafka-authentication" class="header-anchor">#</a> Kafka Authentication</h3> <p>clickhouse_sinker support the following authentication mechanisms:</p> <ul><li>No authentication</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Required if you use sarama. It's the the Kafka server version.&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>SASL/PLAIN</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9094&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sasl&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;enable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mechanism&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PLAIN&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alice-secret&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> config/client_PLAINTEXT_PLAIN.properties
<span class="token assign-left variable">security.protocol</span><span class="token operator">=</span>SASL_PLAINTEXT
<span class="token assign-left variable">sasl.kerberos.service.name</span><span class="token operator">=</span>kafka
<span class="token assign-left variable">sasl.mechanism</span><span class="token operator">=</span>PLAIN
<span class="token assign-left variable">sasl.jaas.config</span><span class="token operator">=</span>org.apache.kafka.common.security.plain.PlainLoginModule required <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">&quot;alice&quot;</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">&quot;alice-secret&quot;</span><span class="token punctuation">;</span>

$ bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--producer.config</span> config/client_PLAINTEXT_PLAIN.properties

$ bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--group</span> test-consumer-group --from-beginning <span class="token parameter variable">--consumer.config</span> config/client_PLAINTEXT_PLAIN.properties
</code></pre></div><ul><li>SASL/SCRAM</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9094&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sasl&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;enable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;@mechanism&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCRAM-SHA-256 or SCRAM-SHA-512&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mechanism&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCRAM-SHA-256&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alice-secret&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> config/client_PLAINTEXT_SCRAM.properties
<span class="token assign-left variable">security.protocol</span><span class="token operator">=</span>SASL_PLAINTEXT
<span class="token assign-left variable">sasl.kerberos.service.name</span><span class="token operator">=</span>kafka
<span class="token assign-left variable">sasl.mechanism</span><span class="token operator">=</span>SCRAM-SHA-256
<span class="token assign-left variable">sasl.jaas.config</span><span class="token operator">=</span>org.apache.kafka.common.security.scram.ScramLoginModule required <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">&quot;alice&quot;</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">&quot;alice-secret&quot;</span><span class="token punctuation">;</span>

$ bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--producer.config</span> config/client_PLAINTEXT_SCRAM.properties

$ bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--group</span> test-consumer-group --from-beginning <span class="token parameter variable">--consumer.config</span> config/client_PLAINTEXT_SCRAM.properties
</code></pre></div><ul><li>SASL/GSSAPI(Kerberos)</li></ul> <p>An example kafka config:</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;kafka&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brokers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.168.31.64:9094&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sasl&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;enable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mechanism&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GSSAPI&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;gssapi&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;@authtype&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1 - Username and password, 2 - Keytab&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;authtype&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;keytabpath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/security/mmmtest.keytab&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;kerberosconfigpath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/krb5.conf&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;servicename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kafka&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;@username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`principal` consists of `username` `@` `realm`&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mmm&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;realm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ALANWANG.COM&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> config/client_PLAINTEXT_GSSAPI.properties
<span class="token assign-left variable">security.protocol</span><span class="token operator">=</span>SASL_PLAINTEXT
<span class="token assign-left variable">sasl.kerberos.service.name</span><span class="token operator">=</span>kafka
<span class="token assign-left variable">sasl.mechanism</span><span class="token operator">=</span>GSSAPI
<span class="token assign-left variable">sasl.jaas.config</span><span class="token operator">=</span>com.sun.security.auth.module.Krb5LoginModule required <span class="token assign-left variable">useKeyTab</span><span class="token operator">=</span>true <span class="token assign-left variable">storeKey</span><span class="token operator">=</span>true <span class="token assign-left variable">debug</span><span class="token operator">=</span>true <span class="token assign-left variable">keyTab</span><span class="token operator">=</span><span class="token string">&quot;/etc/security/mmmtest.keytab&quot;</span> <span class="token assign-left variable">principal</span><span class="token operator">=</span><span class="token string">&quot;mmm@ALANWANG.COM&quot;</span><span class="token punctuation">;</span>

$ bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--producer.config</span> config/client_PLAINTEXT_GSSAPI.properties

$ bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.31.64:9094 <span class="token parameter variable">--topic</span> sunshine <span class="token parameter variable">--group</span> test-consumer-group --from-beginning <span class="token parameter variable">--consumer.config</span> config/client_PLAINTEXT_GSSAPI.properties
</code></pre></div><p>Kerberos setup is complex. Please ensure <a href="https://docs.cloudera.com/runtime/7.2.1/kafka-managing/topics/kafka-manage-cli-consumer.html" target="_blank" rel="noopener noreferrer"><code>kafka-console-consumer.sh</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Kerberos keytab authentication work STRICTLY FOLLOW <a href="https://stackoverflow.com/questions/48744660/kafka-console-consumer-with-kerberos-authentication/49140414#49140414" target="_blank" rel="noopener noreferrer">this article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, then test <code>clickhouse_sinker</code> Kerberos authentication on the SAME machine which <code>kafka-console-consumer.sh</code> runs. I tested sarama Kerberos authentication against Kafka <a href="https://archive.apache.org/dist/kafka/2.2.1/kafka_2.11-2.2.1.tgz" target="_blank" rel="noopener noreferrer">2.2.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Not sure other Kafka versions work.</p> <h3 id="sharding-policy"><a href="#sharding-policy" class="header-anchor">#</a> Sharding Policy</h3> <p>Every message is routed to a determined ClickHouse shard.</p> <p>By default, the shard number is caculated by <code>(kafka_offset/roundup(buffer_size))%clickhouse_shards</code>, where <code>roundup()</code> round upward an unsigned integer to the the nearest 2^n.</p> <p>This above expression can be customized with <code>shardingKey</code> and <code>shardingPolicy</code>. <code>shardingKey</code> value is a column name. <code>shardingPolicy</code> value could be:</p> <ul><li><code>stripe,&lt;size&gt;</code>. This requires <code>shardingKey</code> be a numeric-like (bool, int, float, date etc.) column. The expression is <code>(uint64(shardingKey)/stripe_size)%clickhouse_shards</code>.</li> <li><code>hash</code>. This requires <code>shardingKey</code> be a string-like column. The hash function used internally is <a href="https://github.com/cespare/xxhash" target="_blank" rel="noopener noreferrer">xxHash64<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The expression is <code>xxhash64(string(shardingKey))%clickhouse_shards</code>.</li></ul> <h2 id="configuration-management"><a href="#configuration-management" class="header-anchor">#</a> Configuration Management</h2> <p>The precedence of config items:</p> <ul><li>CLI parameters &gt; env variables</li> <li>Nacos &gt; Local Config File</li></ul> <h3 id="nacos"><a href="#nacos" class="header-anchor">#</a> Nacos</h3> <p>Sinker is able to register with Nacos, get and apply config changes dynamically without restart the whole process.
Controled by:</p> <ul><li>CLI parameters: <code>nacos-addr, nacos-username, nacos-password, nacos-namespace-id, nacos-group, nacos-dataid</code></li> <li>env variables: <code>NACOS_ADDR, NACOS_USERNAME, NACOS_PASSWORD, NACOS_NAMESPACE_ID, NACOS_GROUP, NACOS_DATAID</code></li></ul> <h3 id="local-config-file"><a href="#local-config-file" class="header-anchor">#</a> Local Config File</h3> <p>Currently sinker is able to parse local config file at startup, but unable to detect file changes.
Controled by:</p> <ul><li>CLI parameters: <code>local-cfg-file</code></li> <li>env variables: <code>LOCAL_CFG_FILE</code></li></ul> <h2 id="prometheus-metrics"><a href="#prometheus-metrics" class="header-anchor">#</a> Prometheus Metrics</h2> <p>All metrics are defined in <code>statistics.go</code>. You can create Grafana dashboard for clickhouse_sinker by importing the template <code>clickhouse_sinker-dashboard.json</code>.</p> <ul><li>Pull with prometheus</li></ul> <p>Metrics are exposed at <code>http://ip:port/metrics</code>. IP is the outbound IP of this machine. Port is from CLI <code>--http-port</code> or env <code>HTTP_PORT</code>.</p> <p>Sinker registers with Nacos if CLI <code>--consul-cfg-enable</code> or env <code>CONSUL_REGISTER_ENABLE</code> is present. However Prometheus is <a href="https://github.com/alibaba/nacos/issues/1032" target="_blank" rel="noopener noreferrer">unable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to obtain dynamic service list from nacos server.</p> <ul><li>Push to prometheus</li></ul> <p>If CLI <code>--metric-push-gateway-addrs</code> or env <code>METRIC_PUSH_GATEWAY_ADDRS</code> (a list of comma-separated urls) is present, metrics are pushed to one of given URLs regualarly.</p> <h2 id="extending"><a href="#extending" class="header-anchor">#</a> Extending</h2> <p>There are several abstract interfaces which you can implement to support more message format, message queue and config management mechanism.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Parser <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Parse</span><span class="token punctuation">(</span>bs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> model<span class="token punctuation">.</span>Metric
<span class="token punctuation">}</span>

<span class="token comment">// RemoteConfManager can be implemented by many backends: Nacos, Consul, etcd, ZooKeeper...</span>
<span class="token keyword">type</span> RemoteConfManager <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Init</span><span class="token punctuation">(</span>properties <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">GetConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>conf <span class="token operator">*</span>Config<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token comment">// PublishConfig publishs the config. The manager shall not reference the passed Config object after call.</span>
    <span class="token function">PublishConfig</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="why-not-kafka-engine-built-in-clickhouse"><a href="#why-not-kafka-engine-built-in-clickhouse" class="header-anchor">#</a> Why not <a href="https://clickhouse.tech/docs/en/engines/table-engines/integrations/kafka/" target="_blank" rel="noopener noreferrer"><code>Kafka Engine</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> built in ClickHouse?</h2> <ul><li>My experience indicates <code>Kafka Engine</code> is complicated, buggy and hard to debug.</li> <li><code>Kafka Engine</code> runs inside the db process, lowers the database stability. On the other side, <a href="https://www.vertica.com/" target="_blank" rel="noopener noreferrer">Vertica<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>'s official kafka importer is separated with the database server.</li> <li><code>Kafka Engine</code> doesn't support custom sharding policy.</li> <li>Neither <code>Kafka Engine</code> nor clickhouse_sinker support exactly-once.</li></ul> <h2 id="kafka-compatibility"><a href="#kafka-compatibility" class="header-anchor">#</a> Kafka Compatibility</h2> <p>Kafka release history is at <a href="https://kafka.apache.org/downloads" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Kafka broker <a href="https://kafka.apache.org/protocol#api_versions" target="_blank" rel="noopener noreferrer">exposes versions of various APIs it supports since 0.10.0.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="franz-go-kafka-client"><a href="#franz-go-kafka-client" class="header-anchor">#</a> Franz-go Kafka client</h3> <ul><li>Franz negotiates it's protocol version.</li> <li>Franz supports Kerberos authentication.</li> <li>Franz supports generation cleanup callback.</li> <li>Franz wins Sarama and Kafka-go at benchmark competition.</li> <li>Franz project is young but very active.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/clickhouse_sinker/dev/design.html">
        Design
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/clickhouse_sinker/assets/js/app.7cdffb3e.js" defer></script><script src="/clickhouse_sinker/assets/js/2.15f0877f.js" defer></script><script src="/clickhouse_sinker/assets/js/1.aa70cc6d.js" defer></script><script src="/clickhouse_sinker/assets/js/26.9823b1ee.js" defer></script>
  </body>
</html>
